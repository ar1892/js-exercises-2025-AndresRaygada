<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Market Status (JSON)</title>
</head>
<body>

    <h1>Market Status (JSON)</h1>
    <a href="../index.html">Home</a>

    <h2>Dataset Information</h2>
    <p>
        Using the
        <a href="https://www.alphavantage.co/documentation/#market-status" target="_blank">AlphaVantage Market Status</a>
        endpoint to retrieve the status of global equity markets.
    </p>

    <h2>Setup</h2>
    <p>You will be prompted for your AlphaVantage API key when the page loads.</p>

    <h2>Part 1: Console Output</h2>
    <ol type="A">
        <li>Fetch the data</li>
        <li>Log the number of markets</li>
        <li>Filter equity markets</li>
        <li>Log count of equity markets</li>
        <li>Log market type and region of each</li>
        <li>Find US equity market</li>
        <li>Log full info for US market</li>
    </ol>

    <h2>Part 2: Page Display</h2>
    <ol type="A">
        <li>Display US market region, type, exchanges, open/close, and status</li>
    </ol>

    <hr>
    <h2>Display</h2>
    <div id="display-market-info">
        <p>Region: <span id="display-region">TODO</span></p>
        <p>Market Type: <span id="display-type">TODO</span></p>
        <p>Primary Exchanges: <span id="display-exchanges">TODO</span></p>
        <p>Local Open: <span id="display-open">TODO</span></p>
        <p>Local Close: <span id="display-close">TODO</span></p>
        <p>Current Status: <span id="display-status">TODO</span></p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script type="text/javascript">

        // Store/retrieve API key securely
        let apiKey = sessionStorage.getItem("ALPHAVANTAGE_API_KEY");
        if (!apiKey) {
            apiKey = prompt("Please enter your AlphaVantage API key:");
            sessionStorage.setItem("ALPHAVANTAGE_API_KEY", apiKey);
        }

        // Request URL
        const requestUrl = `https://www.alphavantage.co/query?function=MARKET_STATUS&apikey=${apiKey}`;

        // Fetch and process the data
        d3.json(requestUrl).then(function(data) {
            const markets = data.markets || [];

            console.log("RESPONSE:", data);
            console.log("---------------------");
            console.log("PART 1...");

            // A. Number of markets
            console.log("Total markets:", markets.length);

            // B. Filter equity markets
            const equityMarkets = markets.filter(m => m.market_type === "Equity");
            console.log("Equity Markets:", equityMarkets.length);

            // C. List equity market regions
            equityMarkets.forEach(m => {
                console.log(`Type: ${m.market_type}, Region: ${m.region}`);
            });

            // D. Find US equity market
            const market = equityMarkets.find(m => m.region === "United States");

            if (market) {
                console.log("US Equity Market Info:");
                console.log("Type:", market.market_type);
                console.log("Exchanges:", market.primary_exchanges);
                console.log("Open:", market.local_open);
                console.log("Close:", market.local_close);
                console.log("Status:", market.current_status.toUpperCase());

                console.log("---------------------");
                console.log("PART 2...");

                // Update display
                document.getElementById("display-region").textContent = market.region;
                document.getElementById("display-type").textContent = market.market_type;
                document.getElementById("display-exchanges").textContent = market.primary_exchanges;
                document.getElementById("display-open").textContent = market.local_open;
                document.getElementById("display-close").textContent = market.local_close;
                document.getElementById("display-status").textContent = market.current_status.toUpperCase();
            } else {
                console.warn("US Equity Market not found.");
            }

        }).catch(function(error) {
            console.error("ERROR:", error);
        });

    </script>
</body>
</html>
